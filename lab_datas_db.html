<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conditions Climatiques du Labo</title>
    <meta name="description" content="Conditions climatiques surveill√©es par Raspberry Pi">
    <meta name="author" content="Christophe Aseglio">

    <link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="/assets/css/normalize.css">
    <link rel="stylesheet" href="/assets/css/skeleton.css">
    <link rel="icon" type="image/png" href="/static/images/favicon.png">

    <style>
      body {
        font-family: 'Raleway', sans-serif;
        margin: 0;
        padding: 0;
        overflow: hidden; /* prevents the entire page from scrolling */
      }

      .dashboard-title {
        font-size: 3.5em;
        font-weight: 700;
        background: linear-gradient(90deg, #0078d7, #00c6ff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-transform: uppercase;
        margin: 0;
        letter-spacing: 2px;
      }

      .title-icon {
        font-size: 0.8em;
        margin-right: 10px;
      }

      .top-header {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        background: #f8f8f8;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-sizing: border-box;
        padding: 20px;
        border-bottom: 1px solid #ddd;
      }

      .layout-container {
        margin-top: 80px;
        height: calc(100vh - 80px);
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        padding: 20px;
        overflow: hidden;
        box-sizing: border-box;
      }

      @media screen and (max-width: 768px) {
        .layout-container {
          grid-template-columns: 1fr;
          height: auto;
          overflow: visible;
        }

        .right-column {
          max-height: auto;
          overflow-y: visible;
        }
      }

      .left-column, .middle-column, .right-column {
        background-color: #fff;
        padding: 20px;
        border: 1px solid #ddd;
      }

      .right-column {
        overflow-y: auto;
        max-height: calc(100vh - 40px);
        box-sizing: border-box;
      }

      h2, h1 {
        margin-top: 0;
      }

      .button-primary {
        background-color: #0078d7;
        color: white;
        border: none;
        padding: 10px 15px;
        cursor: pointer;
      }

      .node-button, .node-button-selected {
        display: inline-block;
        padding: 6px 10px;
        margin-right: 5px;
        color: white;
        text-decoration: none;
        background-color: green;
        border-radius: 4px;
      }

      .node-button-selected {
        background-color: #0a5;
        font-weight: bold;
      }

      .time-range-form label {
        display: inline;
        margin-right: 10px;
      }

      .time-range-form input[type="radio"] {
        margin-right: 3px;
      }

      table.u-full-width {
        margin-top: 20px;
        border-collapse: collapse;
        width: 100%;
      }

      table.u-full-width th, table.u-full-width td {
        border-bottom: 1px solid #ddd;
        padding: 5px;
        text-align: left;
      }

      #graph_temp, #graph_humid, #graph_press {
        margin-bottom: 20px;
      }

      .interval-btn {
        background-color: green;
        color: white;
        cursor: pointer;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        margin-left: 10px;
        position: relative;
      }

      .interval-dropdown {
        position: absolute;
        top: 60px;
        right: 20px;
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        display: none;
      }

      .interval-dropdown div {
        padding: 10px;
        cursor: pointer;
      }

      .interval-dropdown div:hover {
        background: #eee;
      }

      .header-controls {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .my-btn, .interval-btn {
        background-color: #0078d7;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      .my-btn:hover, .interval-btn:hover {
        background-color: #005fa3;
      }

      .my-btn.clicked {
        background-color: #00a300;
      }

      table.u-full-width, table.u-full-width th, table.u-full-width td {
        background-color: #fff;
        color: #000;
      }

      body.dark-mode table.u-full-width,
      body.dark-mode table.u-full-width th,
      body.dark-mode table.u-full-width td {
        background-color: #1e1e1e;
        color: #fff;
      }

      body.dark-mode {
        background: #121212;
        color: #fff;
      }

      body.dark-mode .top-header {
        background: #1e1e1e;
        border-bottom: 1px solid #333;
      }

      body.dark-mode .left-column,
      body.dark-mode .middle-column,
      body.dark-mode .right-column {
        background: #1e1e1e;
        border-color: #333;
      }

      body.dark-mode table.u-full-width th,
      body.dark-mode table.u-full-width td {
        border-color: #555;
      }

      body.dark-mode .node-button, body.dark-mode .node-button-selected {
        background: green;
        color: white;
      }

      body.dark-mode .header-controls .my-btn,
      body.dark-mode .header-controls .interval-btn {
        background-color: #444;
        color: #fff;
      }

      body.dark-mode .interval-dropdown {
        background: #1e1e1e;
        border-color: #333;
      }

      body.dark-mode .interval-dropdown div:hover {
        background: #333;
      }
    </style>
    </head>
    <body>
      <div class="top-header">
          <h1 class="dashboard-title">
            <span class="title-icon">üìä</span> Dashboard laboratoire acoustique
          </h1>
          <div class="header-controls">
            <!-- Live datas button -->
            <button class="my-btn" id="btn-live">Live</button>
            <!-- Plotly button -->
            <button class="my-btn" id="btn-plotly">Plotly</button>
            <!-- dark theme button -->
            <button class="my-btn" id="btn-mode">Dark/Light</button>
            <!-- interval button -->
            <button class="interval-btn" id="interval-btn">Intervalle {{ selected_interval }}</button>
            <div class="interval-dropdown" id="interval-dropdown">
              <div data-value="1min">1min</div>
              <div data-value="3min">3min</div>
              <div data-value="5min">5min</div>
              <div data-value="10min">10min</div>
              <div data-value="30min">30min</div>
              <div data-value="60min">60min</div>
            </div>
          </div>
        </div>
      <div class="layout-container">
        <div class="left-column">
          <h2>Cellule {{ node }}</h2>
  
          <div style="margin-bottom:20px;">
            {% for n in range(1,7) %}
              {% if node == n|string %}
                <span class="node-button-selected">Cellule {{ n }}</span>
              {% else %}
                <a class="node-button" href="/lab_datas_db?from={{ start_date }}&to={{ end_date }}&range_time={{ range_time }}&timezone={{ timezone }}&node={{ n }}">Cellule {{ n }}</a>
              {% endif %}
            {% endfor %}
          </div>
  
          <form id="datetime_range" action="/lab_datas_db" method="GET">
            <label for="from">Depuis le</label>
            <input class="u-full-width" id="datetimepicker1" type="text" value="{{ start_date }}" name="from">
  
            <label for="to">√Ä</label>
            <input class="u-full-width" id="datetimepicker2" type="text" value="{{ end_date }}" name="to">
  
            <input type="hidden" class="timezone" name="timezone" value="{{ timezone }}">
            <input type="hidden" name="node" value="{{ node }}">
            <input type="hidden" name="range_time" value="{{ range_time }}">
  
            <input class="button-primary" type="submit" value="Valider" style="margin-top:10px;">
          </form>
  
          <div class="time-range-form" style="margin-top:20px;">
            <form id="range_select" action="/lab_datas_db" method="GET">
              <input type="hidden" class="timezone" name="timezone" value="{{ timezone }}"/>
              <input type="hidden" name="node" value="{{ node }}">
  
              <input type="radio" name="range_time" value="3" id="radio_3" {% if range_time == '3' %}checked{% endif %}/> <label for="radio_3">3h</label>
              <input type="radio" name="range_time" value="6" id="radio_6" {% if range_time == '6' %}checked{% endif %}/> <label for="radio_6">6h</label>
              <input type="radio" name="range_time" value="12" id="radio_12" {% if range_time == '12' %}checked{% endif %}/> <label for="radio_12">12h</label>
              <input type="radio" name="range_time" value="24" id="radio_24" {% if range_time == '24' %}checked{% endif %}/> <label for="radio_24">24h</label>
            </form>
          </div>
        </div>
  
        <div class="middle-column">
          <h2>Graphiques</h2>
          <div id="graph_temp"></div>
          <div id="graph_humid"></div>
          <div id="graph_press"></div>
        </div>
  
        <div class="right-column">
          <h2>Donn√©es historiques</h2>
          <h3>Temp√©ratures, humidit√©, pression</h3>
          <p>Liste de {{ combined_data|length }} √©l√©ments</p>
          <table class="u-full-width">
            <thead>
              <tr>
                <th>#</th>
                <th>Date</th>
                <th>¬∞C</th>
                <th>%</th>
                <th>hPa</th>
              </tr>
            </thead>
            <tbody>
              {% for row in combined_data %}
              <tr>
                <td>{{ loop.index }}</td>
                <td>{{ row.date }}</td>
                <td>{{ row.temp }}</td>
                <td>{{ row.humidity }}</td>
                <td>{{ row.pressure }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
  
      <script src="//code.jquery.com/jquery-3.7.1.min.js"></script>
      <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/jquery-datetimepicker/2.5.9/jquery.datetimepicker.css"/>
      <script src="//cdnjs.cloudflare.com/ajax/libs/jquery-datetimepicker/2.5.9/jquery.datetimepicker.full.min.js"></script>
      <script src="//cdnjs.cloudflare.com/ajax/libs/jstimezonedetect/1.0.7/jstz.min.js"></script>
      <script>
          // define darkMode globally
          var darkMode = (localStorage.getItem('darkMode') === 'true');
          // apply initial mode
          if (darkMode) {
            document.body.classList.add('dark-mode');
          }
        </script>
      <script>
        jQuery(document).ready(function() {
          // initializing datetimepickers
          jQuery('#datetimepicker1').datetimepicker({ format:'Y-m-d H:i:s' });
          jQuery('#datetimepicker2').datetimepicker({ format:'Y-m-d H:i:s' });
  
          // when changing the time range with radios
          jQuery("#range_select input[type=radio]").click(function() {
            const range = jQuery(this).val();
            const now = new Date();
            const fromDate = new Date(now.getTime() - range * 3600 * 1000);
            const toDateStr = now.toISOString().slice(0, 19).replace("T", " ");
            const fromDateStr = fromDate.toISOString().slice(0, 19).replace("T", " ");
  
            jQuery("#datetimepicker1").val(fromDateStr);
            jQuery("#datetimepicker2").val(toDateStr);
  
            // submit the form automatically
            jQuery("#range_select").submit();
          });
  
          // initialize radio based on current range_time
          const currentRange = "{{ range_time }}";
          jQuery("#range_select input[value='" + currentRange + "']").prop("checked", true);
  
          // on submitting the datetime_range form, the timezone is determined dynamically
          jQuery("#datetime_range").submit(function(event) {
            const timezone = jstz.determine();
            jQuery(".timezone").val(timezone.name());
          });
        });
      </script>
  
      <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
      <script>
        google.charts.load('current', {'packages':['corechart']});
        google.charts.setOnLoadCallback(createTempChart);
        google.charts.setOnLoadCallback(createHumChart);
        google.charts.setOnLoadCallback(createPressChart);
  
        function getChartOptions(title, vAxisTitle, darkMode) {
          return {
              width: '100%',
              height: 300,
              backgroundColor: darkMode ? '#121212' : '#ffffff',
              chartArea: {
              backgroundColor: darkMode ? '#121212' : '#ffffff'
              },
              title: title,
              titleTextStyle: {
              color: darkMode ? '#ccc' : '#000'
              },
              curveType: 'function',
              hAxis: {
              title: "Date",
              format: 'dd-MMM-yyyy HH:mm',
              textStyle: { color: darkMode ? '#ccc' : '#000' },
              titleTextStyle: { color: darkMode ? '#ccc' : '#000' },
              gridlines: { color: darkMode ? '#333' : '#CCC' }
              },
              vAxis: {
              title: vAxisTitle,
              textStyle: { color: darkMode ? '#ccc' : '#000' },
              titleTextStyle: { color: darkMode ? '#ccc' : '#000' },
              gridlines: { color: darkMode ? '#333' : '#CCC' }
              },
              legend: {
              textStyle:{ color: darkMode ? '#ccc':'#000' }
              },
              series: {
              0: { color: '#4caf50', lineWidth: 2, areaOpacity: 0.2 }
              }
          };
          }
  
  
        function createTempChart() {
          var data = new google.visualization.DataTable();
          data.addColumn('datetime', 'Heure');
          data.addColumn('number', 'Temp√©rature');
          data.addRows([
            {% for row in temp %}
            [new Date({{ row[0][6:10] }}, {{ row[0][3:5]|int - 1 }}, {{ row[0][0:2] }}, {{ row[0][11:13] }}, {{ row[0][14:16] }}), {{ row[2]|float }}],
            {% endfor %}
          ]);
          var options = getChartOptions('Temp√©rature', 'Temp√©rature (¬∞C)', darkMode);
          var chart = new google.visualization.AreaChart(document.getElementById('graph_temp'));
          chart.draw(data, options);
        }
  
        function createHumChart() {
          var data = new google.visualization.DataTable();
          data.addColumn('datetime', 'Heure');
          data.addColumn('number', 'Humidit√©');
          data.addRows([
            {% for row in hum %}
            [new Date({{ row[0][6:10] }}, {{ row[0][3:5]|int - 1 }}, {{ row[0][0:2] }}, {{ row[0][11:13] }}, {{ row[0][14:16] }}), {{ row[2]|float }}],
            {% endfor %}
          ]);
          var options = getChartOptions('Humidit√©', 'Humidit√© (%)', darkMode);
          var chart = new google.visualization.AreaChart(document.getElementById('graph_humid'));
          chart.draw(data, options);
        }
  
        function createPressChart() {
          var data = new google.visualization.DataTable();
          data.addColumn('datetime', 'Heure');
          data.addColumn('number', 'Pression');
          data.addRows([
            {% for row in press %}
            [new Date({{ row[0][6:10] }}, {{ row[0][3:5]|int - 1 }}, {{ row[0][0:2] }}, {{ row[0][11:13] }}, {{ row[0][14:16] }}), {{ row[2]|float }}],
            {% endfor %}
          ]);
          var options = getChartOptions('Pression', 'Pression (hPa)', darkMode);
          var chart = new google.visualization.AreaChart(document.getElementById('graph_press'));
          chart.draw(data, options);
        }
  
      </script>
      <script>
          var plotlyLink = null; // global variable to store the link once obtained
  
          // live button
          document.getElementById('btn-live').addEventListener('click', function() {
            window.location.href = "/lab_datas?node={{ node }}";
          });
  
          // plotly button
          document.getElementById('btn-plotly').addEventListener('click', function() {
            var btnPlotly = this;
  
            // if I already have a plotly link, just open it
            if (plotlyLink) {
              window.open(plotlyLink, "_blank");
              return;
            }
  
            // otherwise, I generate it
            btnPlotly.classList.add('clicked');
            btnPlotly.textContent = "...envoie";
  
            jQuery.get("/to_plotly", {
              from: "{{ start_date }}",
              to: "{{ end_date }}",
              timezone: "{{timezone}}",
              node: "{{ node }}"
            })
            .done(function(data) {
              plotlyLink = data;
              btnPlotly.textContent = "Afficher";
              btnPlotly.classList.remove('clicked');
            })
            .fail(function() {
              btnPlotly.textContent = "Erreur";
              btnPlotly.classList.remove('clicked');
            });
          });
  
          // handle interval dropdown menu
          var intervalBtn = document.getElementById('interval-btn');
          var intervalDropdown = document.getElementById('interval-dropdown');
  
          intervalBtn.addEventListener('click', function() {
            if(intervalDropdown.style.display === 'none' || intervalDropdown.style.display === '') {
              intervalDropdown.style.display = 'block';
            } else {
              intervalDropdown.style.display = 'none';
            }
          });
  
          // when choosing an interval
          var options = intervalDropdown.querySelectorAll('div[data-value]');
          options.forEach(function(opt) {
            opt.addEventListener('click', function() {
              var val = this.getAttribute('data-value');
              // update the button text
              intervalBtn.textContent = "Intervale " + val;
  
              // hide the menu
              intervalDropdown.style.display = 'none';
  
              // send ajax request to update cron
              jQuery.post("/update_cron", { interval: val })
              .done(function(response) {
                  console.log("Cron updated with interval:", response.selected_interval);
              })
              .fail(function() {
                  console.log("error updating cron");
              });
            });
          });
      </script>
      <script>
          function drawAllCharts() {
          createTempChart();
          createHumChart();
          createPressChart();
          }
  
          document.getElementById('btn-mode').addEventListener('click', function() {
          darkMode = !darkMode;
          if (darkMode) {
              document.body.classList.add('dark-mode');
          } else {
              document.body.classList.remove('dark-mode');
          }
          localStorage.setItem('darkMode', darkMode);
          drawAllCharts(); 
          });
        </script>
    </body>
  </html>
